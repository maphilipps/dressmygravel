# CLAUDE.md

<!-- Generated by Claude Conductor v1.1.2 -->

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 🚨 OBERSTE REGEL: PRAGMATIC MVP FIRST! 🚨

**IMMER einen pragmatischen MVP-basierten Ansatz umsetzen!**

- Ship fast, iterate often
- Funktionierende Lösung > Perfekte Lösung
- Quick & dirty für MVP ist OK - Refactoring kommt später
- Keine Over-Engineering - YAGNI (You Ain't Gonna Need It)
- 80/20 Regel: 80% Funktionalität mit 20% Aufwand
- "Done is better than perfect"

## Critical Context (Read First)

- **Tech Stack**: Next.js 14, TypeScript, Shadcn/ui, Tailwind CSS, Zustand, SWR
- **Project Type**: Weather-based clothing recommendation PWA for gravel cyclists
- **Architecture Pattern**: App Router, Server Components where possible, Client Components for interactivity
- **Data Flow**: IP Geolocation → Weather API → Clothing Engine → UI Components → Affiliate Links
- **Caching Strategy**: Aggressive caching at all layers (Browser, SWR, API, CDN) - 3 hour weather cache
- **API Limits**: OpenWeatherMap (1000 calls/day free tier) - coordinate rounding to 0.1° for efficiency
- **Status**: Pre-MVP phase - Project not yet initialized, Next.js setup pending (Issue #1)
- **REFERENCE**: dressmyrun.js (minified bundle) serves as functional reference only - DO NOT edit directly

## Session Startup Checklist

**IMPORTANT**: At the start of each session, check these items:

1. **Check TASKS.md** - Look for any IN_PROGRESS or BLOCKED tasks from previous sessions
2. **Review recent JOURNAL.md entries** - Scan last 2-3 entries for context
3. **If resuming work**: Load the current task context from TASKS.md before proceeding

## Rules Usage

This project uses comprehensive Claude rules to guide development patterns and best practices. The rules are located in `.claude/rules/` and cover:

### Core Development Principles

- **Compound Engineering Core** (`.claude/rules/compound-engineering-core.md`): Core principles for exponential improvement
- **ADR Workflow** (`.claude/rules/adr-workflow.md`): Architecture Decision Records process
- **GitHub Compound Workflow** (`.claude/rules/github-compound-workflow.md`): Enhanced GitHub workflow with learning loops

### Project-Specific Rules (DressMyGravel)

- **API Integration Patterns** (`.claude/rules/api-integration-patterns.md`): Weather API integration, caching strategies, cost optimization
- **UI Component Patterns** (`.claude/rules/ui-component-patterns.md`): Next.js 14, Shadcn/ui patterns, mobile-first development
- **Performance Requirements** (`.claude/rules/performance-requirements.md`): Core Web Vitals, optimization strategies, monitoring
- **Security Practices** (`.claude/rules/security-practices.md`): API key management, Git security, learned from token exposure incident
- **GitHub Workflow** (`.claude/rules/github-workflow.md`): Issue management, branch strategy, PR standards specific to this project
- **Clothing Recommendation Logic** (`.claude/rules/clothing-recommendation-logic.md`): Temperature zones, weather modifiers, gravel-specific factors
- **Agent Ecosystem Management** (`.claude/rules/agent-ecosystem-management.md`): Agent refactoring protocol, tech stack alignment, domain expertise embedding

**Important**: Always reference these rules when working on the project. They contain critical learnings from the initial setup session, including the API token exposure incident and recovery.

## Table of Contents

1. [Architecture](ARCHITECTURE.md) - Tech stack, folder structure, infrastructure
2. [Design Tokens](DESIGN.md) - Colors, typography, visual system
3. [UI/UX Patterns](UIUX.md) - Components, interactions, accessibility
4. [Runtime Config](CONFIG.md) - Environment variables, feature flags
5. [Data Model](DATA_MODEL.md) - Database schema, entities, relationships
6. [API Contracts](API.md) - Endpoints, request/response formats, auth
7. [Build & Release](BUILD.md) - Build process, deployment, CI/CD
8. [Testing Guide](TEST.md) - Test strategies, E2E scenarios, coverage
9. [Operational Playbooks](PLAYBOOKS/DEPLOY.md) - Deployment, rollback, monitoring
10. [Contributing](CONTRIBUTING.md) - Code style, PR process, conventions
11. [Error Ledger](ERRORS.md) - Critical P0/P1 error tracking
12. [Task Management](TASKS.md) - Active tasks, phase tracking, context preservation

## Quick Reference

**Reference Bundle**: `dressmyrun.js` - Minified reference implementation (DO NOT EDIT)
**Project Spec**: `docs/project-spec.md` - Complete project specification
**GitHub Repo**: https://github.com/maphilipps/dressmygravel
**Issues Board**: https://github.com/maphilipps/dressmygravel/issues
**Architecture**: `ARCHITECTURE.md` - System architecture notes
**Journal**: `JOURNAL.md` - Engineering journal
**ADRs**: `doc/architecture/decisions/` - Architecture decision records

### Key Directories

**Existing**:

- `.claude/` - Claude rules and agents with comprehensive patterns
- `.adrs/` - Architecture decision records
- `.thoughts/` - Research and planning documentation
- `doc/` - ADR decisions directory
- `docs/` - Project documentation with complete spec

**To Be Created (Issue #1)**:

- `app/` - Next.js 14 app router pages and API routes
- `components/` - React components (UI, features)
- `lib/` - Business logic, utilities, services
- `data/` - Static data (clothing items, affiliate products)
- `public/` - Static assets (images, icons, PWA manifest)
- `node_modules/` - Dependencies (after npm install)
- Configuration files: package.json, tsconfig.json, next.config.js, tailwind.config.js

## MVP Development Philosophy

- **Week 1 Goal**: Get something working that shows weather and recommends clothes
- **Shortcuts allowed**: Hardcode data initially, use mock data, skip edge cases
- **Focus on**: Core user journey - See weather → Get recommendations
- **Ignore for now**: Admin panels, complex settings, multiple themes, i18n
- **Simplify aggressively**: One weather API, basic UI, minimal customization
- **Deploy early**: Get it live ASAP, even if incomplete

## Implementation Rules (MANDATORY)

### Project State

- **Current Phase**: Pre-MVP - Project initialization pending
- **Active Issues**: 12 open issues in GitHub
- **Next Steps**:
  1. ✅ Project specification complete
  2. ✅ GitHub repository with issues created
  3. ⏳ Initialize Next.js 14 project (#1)
  4. ⏳ Setup Tailwind CSS and Shadcn/ui (#1)
  5. ⏳ Configure TypeScript and linting (#1)
- **Priority Order**:
  1. Project setup (#1) - NOT STARTED
  2. Location detection (#2) - Blocked by #1
  3. Weather API (#3) - Blocked by #1
  4. Clothing engine (#4) - Blocked by #1
  5. UI components (#5) - Blocked by #1

## Implementation Rules

### API & Data Handling

- **ALWAYS round coordinates to 0.1°** for weather caching efficiency (48.1351 → 48.1)
- **CACHE weather data for minimum 3 hours** - OpenWeatherMap limited to 1000 calls/day
- **USE OpenWeatherMap API** as primary (free tier), WeatherAPI.com as fallback
- **IMPLEMENT retry logic** with exponential backoff for API failures
- **Store API keys in .env.local** - Never commit to repository

### Clothing Logic Rules

- **Temperature zones are FIXED**: HOT >25°C, WARM 15-25°C, COOL 5-15°C, COLD <5°C
- **Gravel rides are LONGER than runs** - Adjust clothing for 2-6 hour rides
- **ALWAYS include helmet as required** - Safety first for cycling
- **Essential gear**: Helmet, gloves (padded), eyewear, bibs with chamois, jersey with pockets
- **Modifiers are CUMULATIVE** - Rain + Wind = waterproof jacket + windproof layer
- **Gravel-specific**: Consider dust protection (buff), vibration (padded gloves), storage (jersey pockets)

### UI/UX Requirements

- **Mobile breakpoint is 640px** - Test everything mobile-first
- **Use Shadcn's Card component** for all weather/clothing displays
- **Dark mode is REQUIRED** - Use Shadcn's theme system
- **Loading states are MANDATORY** - Never show blank screens

### Performance Targets

- **Lighthouse score MUST be >90** on all metrics (LCP <2.5s, FID <100ms, CLS <0.1)
- **Initial load MUST be <2.5s** on 3G connection
- **Images MUST use WebP** with JPEG fallback for older browsers
- **Bundle size MUST be <200KB** for initial JavaScript
- **Cache hit rate >80%** for weather data
- **API calls <500/day** to stay within free tier

## Tech Stack Details

- **Framework**: Next.js 14 with App Router (not Pages Router)
- **Styling**: Tailwind CSS + Shadcn/ui (Radix UI primitives)
- **State**: Zustand for global state (8kb vs Redux 60kb)
- **Data Fetching**: SWR with stale-while-revalidate strategy
- **Forms**: React Hook Form + Zod validation
- **Icons**: Lucide React (tree-shakeable)
- **Analytics**: Google Analytics 4 with event tracking
- **Error Tracking**: Sentry for production monitoring
- **Deployment**: Vercel (optimized for Next.js)

## Agent Ecosystem

The project uses specialized agents for different aspects of development. Agents are located in `.claude/agents/` directory.

### Agent Categories & Usage

#### Next.js Development

- **nextjs-project-initializer**: Complete Next.js 14 project setup with App Router, TypeScript, Shadcn/ui
- **nextjs-step-by-step-implementer**: MVP-focused feature implementation using modern Next.js patterns
- **shadcn-component-developer**: UI component development with mobile-first design and accessibility

#### Weather & Domain-Specific

- **weather-api-integrator**: Weather API integration with intelligent caching and cost optimization
- **clothing-recommendation-engine**: Gravel cycling clothing recommendations based on weather conditions
- **pwa-optimizer**: Progressive Web App implementation with offline caching

#### Performance & Quality

- **performance-optimizer**: Core Web Vitals optimization targeting LCP <2.5s, FID <100ms, CLS <0.1
- **debug-detective**: Cross-platform debugging and troubleshooting
- **production-monitor-agent**: Performance monitoring and error tracking

#### Architecture & Planning

- **mvp-grand-orchestrator**: Overall project coordination with MVP-first approach
- **mvp-spec-interviewer**: Requirements gathering and scope definition
- **feedback-codifier**: Convert learnings into permanent rules and best practices

### Agent Workflows

#### New Project Setup

1. `nextjs-project-initializer` → Initialize Next.js 14 with all dependencies
2. `shadcn-component-developer` → Set up UI components and design system
3. `weather-api-integrator` → Configure weather APIs with caching
4. `pwa-optimizer` → Implement PWA features

#### Feature Development

1. `mvp-spec-interviewer` → Define requirements with MVP focus
2. `nextjs-step-by-step-implementer` → Implement using Next.js patterns
3. `shadcn-component-developer` → Create responsive UI components
4. `weather-api-integrator` → Integrate weather data optimally

#### Performance Optimization

1. `performance-optimizer` → Optimize Core Web Vitals
2. `pwa-optimizer` → Enhance offline capabilities
3. `production-monitor-agent` → Monitor production metrics

### Evolution History

- **2025-01-14**: Refactored from Rails to Next.js 14 ecosystem
- Rails agents deprecated (preserved with DEPRECATED\_ prefix)
- See `.claude/rules/agent-ecosystem-management.md` for refactoring protocol

## MCP Servers (Model Context Protocol)

The project uses several MCP servers to enhance development capabilities:

### Available MCP Servers

- **taskmaster-ai**: Task management and tracking automation
- **playwright**: Browser automation and E2E testing with Puppeteer/Playwright
  - Use for testing UI components and user flows
  - Verify PWA functionality and mobile responsiveness
  - Test weather/location interactions
- **context7**: Documentation and library reference lookup
  - Use for fetching API documentation
  - Get code examples and configuration references
  - Look up best practices for libraries
- **shadcn-ui**: Shadcn/ui component integration
  - Access component templates and examples
  - Get proper implementation patterns
  - Ensure consistent UI component usage

### MCP Usage Guidelines

- **ALWAYS use context7** when needing documentation for libraries, APIs, or configuration
- **ALWAYS use playwright** for testing UI interactions and verifying mobile responsiveness
- **ALWAYS use shadcn-ui MCP** for component implementation guidance
- **Use taskmaster-ai** for complex task orchestration and progress tracking

## Development Workflow (ALWAYS FOLLOW)

When implementing any feature in this codebase, you MUST: 0. **ALWAYS ask: Is this needed for MVP?** - If no, skip it or add TODO for later

1. **ALWAYS work in feature branches** - Never commit directly to main
2. **ALWAYS check existing patterns first** - Look at similar implementations before creating new ones
3. **ALWAYS use Shadcn/ui components** - Don't create custom UI components if Shadcn has one
4. **ALWAYS implement caching for API calls** - Use the established caching patterns in lib/cache
5. **ALWAYS write TypeScript interfaces first** - Define types before implementation
6. **ALWAYS test on mobile viewport** - Mobile-first is mandatory
7. **ALWAYS use environment variables for secrets** - Never hardcode API keys

## Current Project Structure

```
dressmygravel/
├── .claude/           # Claude rules and agents (EXISTS)
│   ├── agents/       # Various specialized agents
│   ├── rules/        # Development rules and patterns
│   └── settings.local.json
├── .adrs/            # Architecture decision records (EXISTS)
├── .thoughts/        # Research and planning notes (EXISTS)
├── doc/              # ADR decisions (EXISTS)
├── docs/             # Project documentation (EXISTS)
│   └── project-spec.md  # Complete specification (EXISTS)
├── dressmyrun.js     # Reference implementation (EXISTS - DO NOT EDIT)
├── ARCHITECTURE.md   # System design notes (EXISTS)
├── BUILD.md         # Build and deployment guide (EXISTS)
├── CLAUDE.md        # This file (EXISTS)
├── CONDUCTOR.md     # Claude Conductor guide (EXISTS)
├── JOURNAL.md       # Development log (EXISTS)
├── .mcp.json        # MCP server configuration (EXISTS)
└── [NO NEXT.JS PROJECT FILES YET - Pending Issue #1]
```

## Task Templates

### 1. Implement New UI Component

1. Install Shadcn component: `npx shadcn-ui@latest add [component]`
2. Create wrapper in `components/[feature]/[component].tsx`
3. Add Storybook story in `[component].stories.tsx`
4. Write tests in `[component].test.tsx`
5. Update component documentation

### 2. Add API Endpoint

1. Create route handler in `app/api/[endpoint]/route.ts`
2. Add TypeScript types in `lib/types/[feature].ts`
3. Implement caching strategy in handler
4. Write API tests
5. Document in API specification

### 3. Implement Feature from Issue

1. Read issue requirements and acceptance criteria
2. Create feature branch: `git checkout -b feature/[issue-number]`
3. Write tests first (TDD approach)
4. Implement feature
5. Verify all tests pass
6. Create PR with "Fixes #[issue-number]"

## Anti-Patterns (NEVER DO THESE)

❌ **NEVER over-engineer for MVP** - No complex patterns until proven needed
❌ **NEVER spend >2 hours on any single feature** - Time-box everything
❌ **NEVER aim for perfection in MVP** - Ship it, then improve it
❌ **NEVER hardcode API keys** - Will be rejected in PR
❌ **NEVER create custom UI components when Shadcn has one** - Consistency matters
❌ **NEVER make uncached API calls** - Every external call must be cached
❌ **NEVER use 'any' type in TypeScript** - Proper types or generics only
❌ **NEVER ignore mobile viewport** - Desktop-only features will be rejected
❌ **NEVER skip loading states** - Users must always see feedback
❌ **NEVER commit .env files** - Use .env.example for templates

## Journal Update Requirements

**IMPORTANT**: Update JOURNAL.md regularly throughout our work sessions:

- After completing any significant feature or fix
- When encountering and resolving errors
- At the end of each work session
- When making architectural decisions
- Format: What/Why/How/Issues/Result structure

## Task Management Integration

**How TASKS.md and JOURNAL.md work together**:

1. **Active Work**: TASKS.md tracks current/incomplete tasks with full context
2. **Completed Work**: When tasks complete, they generate JOURNAL.md entries with `|TASK:ID|` tags
3. **History**: JOURNAL.md preserves complete task history even if Claude Code is reinstalled
4. **Context Recovery**: Search JOURNAL.md for `|TASK:` to see all completed tasks over time
5. **Clean Handoffs**: TASKS.md always shows what needs to be resumed or completed

## Version History

- **v1.0.0** - Initial release
- **v1.1.0** - Feature added (see JOURNAL.md YYYY-MM-DD)  
  [Link major versions to journal entries]
